"""Copybara workflow for importing changes from upstream into the EngFlow monorepo."""

core.workflow(
    name = "import",
    origin = git.origin(
        url = "https://github.com/googleapis/googleapis",
        ref = "master",
    ),
    destination = git.github_pr_destination(
        url = "git@github.com:EngFlow/engflow.git",
        destination_ref = "master",
        pr_branch = "copybara/import_googleapis",
        title = """
[googleapis] import ${COPYBARA_LAST_REV}...${COPYBARA_CURRENT_REV}
""".strip(),
        body = """
https://github.com/googleapis/googleapis/compare/${COPYBARA_LAST_REV}...${COPYBARA_CURRENT_REV}
""".strip(),
        update_description = True,
    ),
    mode = "SQUASH",
    origin_files = glob([
        "LICENSE",
        "google/*.proto",
        "google/**/*.proto",
    ]),
    destination_files = glob(
        [
            "third_party/googleapis/LICENSE",
            "third_party/googleapis/google/**",
        ],
        exclude = [
            "**/BUILD",
        ],
    ),
    authoring = authoring.pass_thru("EngFlow GitHub Automation <engflow-github-automation@engflow.com>"),
    transformations = [
        metadata.squash_notes(
            prefix = """
[googleapis] import ${COPYBARA_LAST_REV}...${COPYBARA_CURRENT_REV}

https://github.com/googleapis/googleapis/compare/${COPYBARA_LAST_REV}...${COPYBARA_CURRENT_REV}
""".strip() + "\n\n",
            compact = True,
            oldest_first = True,
        ),
        core.move("", "third_party/googleapis"),
    ],
)
